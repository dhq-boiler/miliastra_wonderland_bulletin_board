<div class="comment-item">
  <div class="comment-header">
    <span class="comment-author">
      <%= link_to comment.user.display_name, user_path(comment.user), class: "text-blue-600 hover:text-blue-800 underline" %>
      <% if comment.user.admin? %>
        <span class="admin-badge"><%= t('app.common.admin_badge') %></span>
      <% end %>
    </span>
    <div class="comment-date-group">
      <span class="comment-date">
        <%= l(comment.created_at, format: :long) %>
      </span>
      <%= diff_time(comment.created_at, "span", { class: "diff-date" }, auto_update: true) %>
    </div>
  </div>
  <div class="comment-content">
    <%= simple_format(comment.content) %>
  </div>
  <% if comment.images.attached? %>
    <div class="comment-images" data-controller="image-viewer">
      <% comment.images.each do |image| %>
        <% is_reported = ImageReport.image_reported?(image.id) %>
        <% report_count = ImageReport.report_count(image.id) %>
        <% user_reported = logged_in? && ImageReport.exists?(active_storage_attachment_id: image.id, user_id: current_user.id) %>

        <div class="image-container <%= 'reported-image' if is_reported %>">
          <%= image_tag image, class: "comment-image #{'blurred' if is_reported}", style: "max-width: 400px; max-height: 300px; width: auto; height: auto; cursor: pointer;", data: { action: "click->image-viewer#openModal" } %>

          <div class="image-report-info">
            <% if report_count > 0 %>
              <span class="report-count">⚠️ 通報数: <%= report_count %></span>
            <% end %>

            <% if logged_in? %>
              <% if user_reported %>
                <span class="reported-badge">通報済み</span>
              <% else %>
                <%= button_to "この画像を通報", image_reports_path(attachment_id: image.id),
                    method: :post,
                    class: "btn-report",
                    data: {
                      turbo: false,
                      confirm: "この画像を通報しますか？"
                    },
                    form: { data: { turbo: false } } %>
              <% end %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>
  <% if can_delete_comment?(comment) %>
    <div class="comment-actions">
      <%= button_to t('app.common.delete'), multiplay_recruitment_comment_path(multiplay_recruitment, comment),
                    method: :delete,
                    data: { turbo_confirm: t('app.multiplay.show.confirm_delete_comment') },
                    class: "btn-comment-delete" %>
    </div>
  <% end %>
</div>

