<div class="admin-container">
  <h1 class="admin-header">ユーザー詳細: <%= @user.display_name %></h1>

  <!-- ユーザー基本情報 -->
  <div class="detail-section">
    <h3>基本情報</h3>
    <table class="detail-table">
      <tr>
        <th>ユーザー名</th>
        <td><%= @user.username %></td>
      </tr>
      <tr>
        <th>ニックネーム</th>
        <td><%= @user.nickname.present? ? @user.nickname : "-" %></td>
      </tr>
      <tr>
        <th>メール</th>
        <td><%= @user.email.present? ? @user.email : "-" %></td>
      </tr>
      <tr>
        <th>ステータス</th>
        <td>
          <% if @user.banned? %>
            <span class="user-status-badge banned">BAN済み</span>
            <div class="status-detail">
              <strong>BAN日時:</strong> <%= l(@user.banned_at, format: :long) %><br>
              <% if @user.ban_reason.present? %>
                <strong>理由:</strong> <%= simple_format(@user.ban_reason) %>
              <% end %>
            </div>
          <% elsif @user.suspended? %>
            <span class="user-status-badge suspended">停止中</span>
            <div class="status-detail">
              <strong>停止期限:</strong> <%= l(@user.suspended_at, format: :long) %><br>
              <% if @user.suspension_reason.present? %>
                <strong>理由:</strong> <%= simple_format(@user.suspension_reason) %>
              <% end %>
            </div>
          <% else %>
            <span class="user-status-badge active">アクティブ</span>
          <% end %>
        </td>
      </tr>
      <tr>
        <th>役割</th>
        <td>
          <% if @user.admin? %>
            <span class="role-badge admin">管理者</span>
          <% else %>
            <span class="role-badge user">一般ユーザー</span>
          <% end %>
        </td>
      </tr>
      <tr>
        <th>登録日</th>
        <td><%= l(@user.created_at, format: :long) %></td>
      </tr>
      <tr>
        <th>言語設定</th>
        <td><%= t("languages.#{@user.locale}") %></td>
      </tr>
    </table>
  </div>

  <!-- 活動統計 -->
  <div class="detail-section">
    <h3>活動統計</h3>
    <table class="detail-table">
      <tr>
        <th>幻境投稿数</th>
        <td><%= @user.stages.count %> 件</td>
      </tr>
      <tr>
        <th>コメント数</th>
        <td><%= @user.multiplay_recruitment_comments.count %> 件</td>
      </tr>
      <tr>
        <th>通報した数</th>
        <td><%= @reports_made.count %> 件</td>
      </tr>
      <tr>
        <th>通報された数</th>
        <td><%= @reports_received.count %> 件</td>
      </tr>
    </table>
  </div>

  <!-- 最近の幻境投稿 -->
  <div class="detail-section">
    <h3>最近の幻境投稿 (最新10件)</h3>
    <% if @stages.any? %>
      <ul class="activity-list">
        <% @stages.each do |stage| %>
          <li>
            <%= link_to stage.title, stage_path(stage), class: "activity-link" %>
            <span class="activity-date"><%= l(stage.created_at, format: :short) %></span>
          </li>
        <% end %>
      </ul>
    <% else %>
      <p class="text-muted">投稿なし</p>
    <% end %>
  </div>

  <!-- 最近のコメント -->
  <div class="detail-section">
    <h3>最近のコメント (最新10件)</h3>
    <% if @comments.any? %>
      <ul class="activity-list">
        <% @comments.each do |comment| %>
          <li>
            <%= link_to truncate(comment.content, length: 50), multiplay_recruitment_path(comment.multiplay_recruitment), class: "activity-link" %>
            <span class="activity-date"><%= l(comment.created_at, format: :short) %></span>
          </li>
        <% end %>
      </ul>
    <% else %>
      <p class="text-muted">コメントなし</p>
    <% end %>
  </div>

  <!-- 通報履歴 -->
  <div class="detail-section">
    <h3>通報履歴 (受けた通報)</h3>
    <% if @reports_received.any? %>
      <table class="admin-table">
        <thead>
          <tr>
            <th>通報者</th>
            <th>理由</th>
            <th>ステータス</th>
            <th>日時</th>
          </tr>
        </thead>
        <tbody>
          <% @reports_received.each do |report| %>
            <tr>
              <td><%= link_to report.user.display_name, user_path(report.user), class: "user-link" %></td>
              <td><%= truncate(report.reason, length: 50) || "理由なし" %></td>
              <td>
                <span class="status-badge status-<%= report.status %>">
                  <%= case report.status
                      when ImageReport::STATUSES[:pending] then "未確認"
                      when ImageReport::STATUSES[:confirmed] then "不適切"
                      when ImageReport::STATUSES[:dismissed] then "却下"
                      when ImageReport::STATUSES[:reviewed] then "レビュー済み"
                      end %>
                </span>
              </td>
              <td><%= l(report.created_at, format: :short) %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p class="text-muted">通報なし</p>
    <% end %>
  </div>

  <!-- 管理アクション -->
  <div class="detail-actions">
    <h3>管理アクション</h3>

    <% if @user.active? %>
      <div class="action-group">
        <%= form_with url: suspend_admin_user_path(@user), method: :patch, class: "inline-form" do |f| %>
          <div class="form-group-inline">
            <%= f.label :duration, "停止期間（日数）:" %>
            <%= f.number_field :duration, value: 7, min: 1, max: 365, class: "form-control-small" %>
          </div>
          <div class="form-group-inline">
            <%= f.label :reason, "理由:" %>
            <%= f.text_area :reason, rows: 2, class: "form-control", placeholder: "停止理由を入力" %>
          </div>
          <%= f.submit "ユーザーを停止", class: "btn btn-warning", data: { turbo_confirm: "このユーザーを停止しますか？" } %>
        <% end %>
      </div>

      <div class="action-group">
        <%= form_with url: ban_admin_user_path(@user), method: :patch, class: "inline-form" do |f| %>
          <div class="form-group-inline">
            <%= f.label :reason, "理由:" %>
            <%= f.text_area :reason, rows: 2, class: "form-control", placeholder: "BAN理由を入力" %>
          </div>
          <%= f.submit "ユーザーをBAN", class: "btn btn-danger", data: { turbo_confirm: "このユーザーを永久BANしますか？この操作は慎重に行ってください。" } %>
        <% end %>
      </div>
    <% elsif @user.suspended? %>
      <div class="action-group">
        <%= button_to "停止を解除", unsuspend_admin_user_path(@user), method: :patch, class: "btn btn-success", data: { turbo_confirm: "このユーザーの停止を解除しますか？" } %>
      </div>
    <% elsif @user.banned? %>
      <div class="action-group">
        <%= button_to "BANを解除", unban_admin_user_path(@user), method: :patch, class: "btn btn-success", data: { turbo_confirm: "このユーザーのBANを解除しますか？" } %>
      </div>
    <% end %>
  </div>

  <div class="admin-actions">
    <%= link_to "ユーザー一覧に戻る", admin_users_path, class: "btn btn-default" %>
    <%= link_to "公開プロフィール", user_path(@user), class: "btn btn-secondary" %>
  </div>
</div>
