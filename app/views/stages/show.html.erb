<div class="max-w-4xl mx-auto p-5 bg-white min-h-screen">
  <div class="stage-detail">
    <h1 class="text-gray-800 border-b-4 border-blue-500 pb-2.5 mb-8 text-3xl font-bold"><%= @stage.title %></h1>

    <div class="stage-info flex justify-between items-start">
      <div>
        <span class="stage-guid"><%= t('app.common.guid') %>: <%= clipboard_copy(@stage.stage_guid) %></span>
        <% if @stage.difficulty.present? %>
          <span class="difficulty"><%= t('app.common.difficulty_label') %>: <%= @stage.difficulty_text %></span>
        <% end %>
        <% if @stage.locale.present? %>
          <span class="language"><%= t('app.common.language_label') %>: <%= t("languages.#{@stage.locale}") %></span>
        <% end %>
      </div>
      <div class="flex gap-2">
        <%= link_to t('app.stages.show.official_page'), "https://act.hoyolab.com/ys/ugc_community/mx/?lang=ja-jp&bbs_theme=dark&bbs_theme_device=1#/pages/level-detail/index?id=#{@stage.stage_guid}&region=os_asia", class: "btn btn-primary", target: "_blank", rel: "noopener noreferrer" %>
        <% if @multiplay_recruitments_count > 0 %>
          <%= link_to multiplay_recruitments_path(stage_guid: @stage.stage_guid), class: "btn btn-secondary", target: "_blank", rel: "noopener noreferrer" do %>
            <%= t('app.stages.show.multiplay_recruitments') %> (<%= @multiplay_recruitments_count %>)
          <% end %>
        <% end %>
      </div>
    </div>

    <!-- タグ表示 -->
    <% if @stage.tags.any? %>
      <div class="stage-tags mt-4 mb-4">
        <% @stage.tags.each do |tag| %>
          <span class="tag-badge bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm mr-1"><%= tag.name %></span>
        <% end %>
      </div>
    <% end %>

    <div class="stage-content">
      <h3><%= t('app.stages.show.description_title') %></h3>
      <div class="description"><%= simple_format(@stage.description) %></div>

      <% if @stage.tips.present? %>
        <h3><%= t('app.stages.show.tips_title') %></h3>
        <div class="tips"><%= simple_format(@stage.tips) %></div>
      <% end %>

      <% if @stage.images.attached? %>
        <h3>画像</h3>
        <div class="stage-images" data-controller="image-viewer image-report" data-action="keydown@window->image-report#handleKeydown">
          <% @stage.images.each do |image| %>
            <% is_reported = ImageReport.image_reported?(image.id) %>
            <% report_count = ImageReport.report_count(image.id) %>
            <% user_reported = logged_in? && ImageReport.exists?(active_storage_attachment_id: image.id, user_id: current_user.id) %>

            <div class="image-container <%= 'reported-image' if is_reported %>">
              <%= image_tag image, class: "stage-image #{'blurred' if is_reported}", style: "max-width: 800px; max-height: 600px; width: auto; height: auto; cursor: pointer;", data: { action: "click->image-viewer#openModal" } %>

              <div class="image-report-info">
                <% if report_count > 0 %>
                  <span class="report-count">⚠️ 通報数: <%= report_count %></span>
                <% end %>

                <% if logged_in? %>
                  <% if user_reported %>
                    <span class="reported-badge">通報済み</span>
                  <% else %>
                    <button type="button"
                            class="btn-report"
                            data-attachment-id="<%= image.id %>"
                            data-action="click->image-report#openModal">
                      この画像を通報
                    </button>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <div class="meta">
      <p>
        <%= t('app.common.posted_by') %>: <%= link_to @stage.user.display_name, user_path(@stage.user), class: "text-blue-600 hover:text-blue-800 underline" %>
        <% if @stage.user.admin? %>
          <span class="admin-badge"><%= t('app.common.admin_badge') %></span>
        <% end %>
      </p>
      <p><%= t('app.common.posted_at') %>: <%= l(@stage.created_at, format: :long) %></p>
      <% if @stage.updated_at != @stage.created_at %>
        <p><%= t('app.stages.show.updated_at') %>: <%= l(@stage.updated_at, format: :long) %></p>
      <% end %>
    </div>

    <div class="actions">
      <% if logged_in? %>
        <% if @stage.user == current_user %>
          <%= link_to t('app.common.edit'), edit_stage_path(@stage), class: "btn btn-secondary" %>
          <%= button_to t('app.common.delete'), stage_path(@stage), method: :delete, data: { turbo_confirm: t('app.stages.show.confirm_delete') }, class: "btn btn-danger" %>
        <% elsif current_user.admin? %>
          <%= button_to t('app.common.delete'), stage_path(@stage), method: :delete, data: { turbo_confirm: t('app.stages.show.confirm_delete_admin') }, class: "btn btn-danger" %>
        <% end %>
      <% end %>
      <%= link_to t('app.common.back'), stages_path, class: "btn btn-default" %>
    </div>
  </div>
</div>

<% if logged_in? %>
  <!-- 画像通報モーダル -->
  <div class="image-report-modal" data-image-report-target="modal" data-action="click->image-report#closeModal">
    <div class="modal-content-report" data-action="click->image-report#closeModal:stop">
      <div class="modal-header">
        <h2>画像を通報</h2>
        <button type="button" class="modal-close" data-action="click->image-report#closeModal">&times;</button>
      </div>

      <%= form_with url: image_reports_path, method: :post, data: { image_report_target: "form", turbo: false, action: "submit->image-report#submitReport" } do |f| %>
        <%= f.hidden_field :attachment_id, data: { image_report_target: "attachmentId" } %>

        <div class="modal-body">
          <h3>通報理由を選択してください</h3>
          <div class="report-categories">
            <% ImageReport::REASON_CATEGORIES.each do |key, label| %>
              <button type="button"
                      class="category-btn"
                      data-category="<%= key %>"
                      data-image-report-target="category"
                      data-action="click->image-report#selectCategory">
                <%= label %>
              </button>
            <% end %>
          </div>

          <div class="report-details">
            <label for="report_details">詳細（必須）</label>
            <%= f.text_area :reason, id: "report_details", data: { image_report_target: "details" }, placeholder: "通報理由の詳細を入力してください", rows: 4 %>
            <p class="help-text">選択したカテゴリについて、具体的な内容を記載してください。</p>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-action="click->image-report#closeModal">キャンセル</button>
          <%= f.submit "通報する", class: "btn btn-danger" %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

