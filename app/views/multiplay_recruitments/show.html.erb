<div class="max-w-4xl mx-auto p-5 bg-white min-h-screen">
  <div class="stage-detail">
    <h1 class="text-gray-800 border-b-4 border-purple-500 pb-2.5 mb-8 text-3xl font-bold"><%= @multiplay_recruitment.title %></h1>

    <div class="stage-info">
      <span class="<%= status_badge_class(@multiplay_recruitment.status) %>"><%= status_text(@multiplay_recruitment.status) %></span>
      <% if @multiplay_recruitment.stage_guid.present? %>
        <% stage = @multiplay_recruitment.stage %>
        <% if stage %>
          <span class="stage-guid">
            <%= link_to stage.title, stage_path(stage), class: "stage-link-white" %> - <%= t('app.common.guid') %>: <%= clipboard_copy(@multiplay_recruitment.stage_guid) %>
          </span>
        <% else %>
          <span class="stage-guid"><%= t('app.common.guid') %>: <%= clipboard_copy(@multiplay_recruitment.stage_guid) %></span>
        <% end %>
      <% end %>
      <% if @multiplay_recruitment.difficulty.present? %>
        <span class="difficulty"><%= t('app.common.difficulty_label') %>: <%= @multiplay_recruitment.difficulty %></span>
      <% end %>
      <span class="max-players"><%= t('app.common.max_players') %>: <%= @multiplay_recruitment.max_players %><%= t('app.common.people') %></span>
      <% if @multiplay_recruitment.start_time.present? %>
        <span class="start-time"><%= t('app.common.start_time') %>: <%= l(@multiplay_recruitment.start_time, format: :long) %></span>
      <% end %>
      <% if @multiplay_recruitment.end_time.present? %>
        <span class="end-time"><%= t('app.common.end_time') %>: <%= l(@multiplay_recruitment.end_time, format: :long) %></span>
      <% end %>
    </div>

    <div class="stage-content">
      <h3><%= t('app.multiplay.show.details_title') %></h3>
      <p class="description"><%= simple_format(@multiplay_recruitment.description) %></p>
    </div>

    <div class="meta">
      <p>
        <%= t('app.common.posted_by') %>: <%= link_to @multiplay_recruitment.user.display_name, user_path(@multiplay_recruitment.user), class: "text-blue-600 hover:text-blue-800 underline" %>
        <% if @multiplay_recruitment.user.admin? %>
          <span class="admin-badge"><%= t('app.common.admin_badge') %></span>
        <% end %>
      </p>
      <p><%= t('app.common.posted_at') %>: <%= l(@multiplay_recruitment.created_at, format: :long) %></p>
      <% if @multiplay_recruitment.updated_at != @multiplay_recruitment.created_at %>
        <p><%= t('app.multiplay.show.updated_at') %>: <%= l(@multiplay_recruitment.updated_at, format: :long) %></p>
      <% end %>
    </div>

    <div class="actions">
      <% if logged_in? %>
        <% if @multiplay_recruitment.user == current_user %>
          <%= link_to t('app.common.edit'), edit_multiplay_recruitment_path(@multiplay_recruitment), class: "btn btn-secondary" %>
          <%= button_to t('app.common.delete'), multiplay_recruitment_path(@multiplay_recruitment), method: :delete, data: { turbo_confirm: t('app.multiplay.show.confirm_delete') }, class: "btn btn-danger" %>
        <% elsif current_user.admin? %>
          <%= button_to t('app.common.delete'), multiplay_recruitment_path(@multiplay_recruitment), method: :delete, data: { turbo_confirm: t('app.multiplay.show.confirm_delete_admin') }, class: "btn btn-danger" %>
        <% end %>
      <% end %>
      <%= link_to t('app.common.back'), multiplay_recruitments_path, class: "btn btn-default" %>
    </div>

    <!-- 参加者セクション -->
    <div class="participants-section mt-8 p-6 bg-gray-50 rounded-lg">
      <h2 class="text-2xl font-bold mb-4 text-gray-800">
        <%= t('app.multiplay.participants.title') %>
        (<%= @multiplay_recruitment.participants.count %>/<%= @multiplay_recruitment.max_players %>)
      </h2>

      <% if logged_in? && @multiplay_recruitment.status == MultiplayRecruitment::STATUSES[:recruiting] %>
        <div class="mb-6">
          <% is_participating = @multiplay_recruitment.participants.exists?(user: current_user) %>
          <% if is_participating %>
            <%= button_to t('app.multiplay.participants.cancel'),
                multiplay_recruitment_participant_path(@multiplay_recruitment),
                method: :delete,
                class: "btn btn-danger",
                data: { turbo_confirm: t('app.multiplay.participants.confirm_cancel') } %>
          <% else %>
            <%= button_to t('app.multiplay.participants.join'),
                multiplay_recruitment_participant_path(@multiplay_recruitment),
                method: :post,
                class: "btn btn-primary" %>
          <% end %>
        </div>
      <% elsif !logged_in? %>
        <p class="text-gray-600 mb-4">
          <%= t('app.multiplay.participants.login_required_html', login_link: link_to(t('app.menu.login'), login_path, class: "text-blue-600 hover:text-blue-800 underline")).html_safe %>
        </p>
      <% end %>

      <% if @multiplay_recruitment.participants.any? %>
        <div class="participants-list">
          <h3 class="text-lg font-semibold mb-3 text-gray-700"><%= t('app.multiplay.participants.list') %></h3>
          <ul class="space-y-2">
            <% @multiplay_recruitment.participants.includes(:user).order(created_at: :asc).each do |participant| %>
              <li class="flex items-center space-x-2 text-gray-700">
                <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                <%= link_to participant.user.display_name, user_path(participant.user), class: "text-blue-600 hover:text-blue-800 underline" %>
                <% if participant.user.admin? %>
                  <span class="admin-badge"><%= t('app.common.admin_badge') %></span>
                <% end %>
                <% if current_user == @multiplay_recruitment.user && participant.user.ingame_uid.present? %>
                  <span class="stage-guid">UID: <%= clipboard_copy(participant.user.ingame_uid) %></span>
                <% end %>
                <%= diff_time(participant.created_at, "span", { class: "text-sm text-gray-500" }, auto_update: true) %>
              </li>
            <% end %>
          </ul>
        </div>
      <% else %>
        <p class="text-gray-500 italic"><%= t('app.multiplay.participants.no_participants') %></p>
      <% end %>
    </div>

    <!-- コメントセクション -->
    <div class="comments-section">
      <h2 class="comments-title"><%= t('app.multiplay.show.comments_title', count: @comments.count) %></h2>

      <% if logged_in? %>
        <%= render "multiplay_recruitment_comments/form", multiplay_recruitment: @multiplay_recruitment, comment: @comment %>
      <% else %>
        <p class="login-prompt"><%= t('app.multiplay.show.login_required_html', login_link: link_to(t('app.menu.login'), login_path)).html_safe %></p>
      <% end %>

      <div class="comments-list">
        <% if @comments.any? %>
          <% @comments.each do |comment| %>
            <%= render "multiplay_recruitment_comments/comment", comment: comment, multiplay_recruitment: @multiplay_recruitment %>
          <% end %>
        <% else %>
          <p class="no-comments"><%= t('app.multiplay.show.no_comments') %></p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<%= render 'shared/image_report_modal' %>

