<div class="max-w-4xl mx-auto p-5 bg-white min-h-screen">
  <h1 class="text-gray-800 border-b-4 border-purple-500 pb-2.5 mb-8 text-3xl font-bold"><%= t('app.multiplay.title') %></h1>

  <div class="actions">
    <% if logged_in? %>
      <%= link_to t('app.multiplay.new_post'), new_multiplay_recruitment_path, class: "btn btn-primary" %>
    <% else %>
      <p class="login-prompt"><%= t('app.multiplay.login_required', login_link: link_to(t('app.menu.login'), login_path)).html_safe %></p>
    <% end %>
  </div>

  <!-- Ê§úÁ¥¢„Éï„Ç©„Éº„É† -->
  <div class="mt-6 mb-6">
    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
      <!-- Ê§úÁ¥¢„Éò„ÉÉ„ÉÄ„Éº -->
      <button type="button" onclick="toggleSearchForm()" class="search-toggle-button w-full px-6 py-4 flex items-center justify-between transition-all duration-200 cursor-pointer">
        <div class="flex items-center gap-3">
          <svg class="search-icon w-4 h-4 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <span class="search-text text-base font-semibold text-gray-800" style="white-space: nowrap;"><%= t('app.multiplay.search.title') %></span>
          <% if @search_keyword.present? || @search_stage_guid.present? || @search_difficulty.present? || @search_status.present? %>
            <span class="px-2.5 py-0.5 text-xs font-semibold bg-blue-100 text-blue-700 rounded"><%= t('app.multiplay.search.active') %></span>
          <% end %>
        </div>
        <svg id="search-chevron" class="search-chevron w-4 h-4 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>

      <!-- Ê§úÁ¥¢„Éï„Ç©„Éº„É†„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
      <div id="search-form-content" class="<%= (@search_keyword.present? || @search_stage_guid.present? || @search_difficulty.present? || @search_status.present?) ? '' : 'hidden' %>">
        <%= form_with url: multiplay_recruitments_path, method: :get, local: true, class: "p-6 border-t border-gray-200 bg-gray-50" do |f| %>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- „Ç≠„Éº„ÉØ„Éº„ÉâÊ§úÁ¥¢ -->
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <%= t('app.multiplay.search.keyword') %>
              </label>
              <%= f.text_field :keyword, value: @search_keyword, placeholder: t('app.multiplay.search.keyword_placeholder'), class: "form-control w-full" %>
            </div>

            <!-- „Çπ„ÉÜ„Éº„Ç∏GUID -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <%= t('app.multiplay.search.stage_guid') %>
              </label>

              <div class="flex gap-2 items-start">
                <%= f.text_field :stage_guid, value: @search_stage_guid, placeholder: t('app.multiplay.search.stage_guid_placeholder'), class: "form-control flex-1", id: "search-stage-guid-field" %>

                <button type="button" class="btn btn-secondary" popovertarget="search-stage-popover" style="white-space: nowrap;">
                  üéÆ <%= t('app.multiplay.form.select_stage_button') %>
                </button>
              </div>

              <div id="search-stage-selection-summary" class="mt-2 text-sm">
                <% if @search_stage_guid.present? %>
                  <% selected_stage = Stage.find_by(stage_guid: @search_stage_guid) %>
                  <% if selected_stage %>
                    <span class="stage-selected-badge">
                      <%= selected_stage.title %> (GUID: <%= @search_stage_guid %>)
                      <button type="button" class="stage-clear-button" data-search-stage-clear>√ó</button>
                    </span>
                  <% else %>
                    <span class="stage-selected-badge">
                      GUID: <%= @search_stage_guid %>
                      <button type="button" class="stage-clear-button" data-search-stage-clear>√ó</button>
                    </span>
                  <% end %>
                <% else %>
                  <span class="text-muted"><%= t('app.multiplay.form.no_stage_selected') %></span>
                <% end %>
              </div>

              <!-- „Çπ„ÉÜ„Éº„Ç∏ÈÅ∏Êäû„Éù„ÉÉ„Éó„Ç™„Éº„Éê„Éº -->
              <%= render partial: 'multiplay_recruitments/stage_selector_popover',
                         locals: {
                           popover_id: 'search-stage-popover',
                           data_prefix: 'search-stage',
                           my_stages: logged_in? ? @my_stages : [],
                           other_stages: logged_in? ? @other_stages : [],
                           all_stages: logged_in? ? [] : @all_stages,
                           show_close_button: false
                         } %>
            </div>

            <!-- Èõ£ÊòìÂ∫¶ -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <%= t('app.multiplay.search.difficulty') %>
              </label>
              <%= f.select :difficulty, difficulty_options, { selected: @search_difficulty }, class: "form-control w-full" %>
            </div>

            <!-- „Çπ„ÉÜ„Éº„Çø„Çπ -->
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <%= t('app.multiplay.search.status') %>
              </label>
              <%= f.select :status, [["", ""]] + status_options, { selected: @search_status }, class: "form-control w-full" %>
            </div>
          </div>

          <!-- „Éú„Çø„É≥ -->
          <div class="flex gap-3 mt-4 pt-4 border-t border-gray-200">
            <%= f.submit t('app.multiplay.search.submit'), class: "btn btn-primary" %>
            <%= link_to t('app.multiplay.search.reset'), multiplay_recruitments_path, class: "btn btn-secondary" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <script>
    function toggleSearchForm() {
      const content = document.getElementById('search-form-content');
      const chevron = document.getElementById('search-chevron');
      content.classList.toggle('hidden');
      chevron.classList.toggle('rotate-180');
    }
  </script>

  <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
  <div class="mt-8 mb-0">
    <nav class="flex justify-evenly gap-3 bg-gradient-to-b from-gray-50 to-white p-2 rounded-t-xl border-b-0">
      <button id="active-tab" class="tab-button group relative px-12 py-4 font-semibold transition-all duration-300 ease-out rounded-lg flex-1 max-w-xs" onclick="switchTab('active')">
        <span class="flex items-center justify-center gap-3">
          <svg class="w-6 h-6 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
          <span class="text-base font-bold"><%= t('app.multiplay.tab_active') %></span>
          <span class="tab-badge inline-flex items-center justify-center min-w-[2rem] h-8 px-2.5 text-sm font-bold rounded-lg transition-all duration-300">
            <%= @active_recruitments.size %>
          </span>
        </span>
        <div class="tab-indicator absolute bottom-0 left-0 right-0 h-1 rounded-t-full transition-all duration-300"></div>
      </button>
      <button id="past-tab" class="tab-button group relative px-12 py-4 font-semibold transition-all duration-300 ease-out rounded-lg flex-1 max-w-xs" onclick="switchTab('past')">
        <span class="flex items-center justify-center gap-3">
          <svg class="w-6 h-6 transition-transform group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span class="text-base font-bold"><%= t('app.multiplay.tab_past') %></span>
          <span class="tab-badge inline-flex items-center justify-center min-w-[2rem] h-8 px-2.5 text-sm font-bold rounded-lg transition-all duration-300">
            <%= @past_recruitments.size %>
          </span>
        </span>
        <div class="tab-indicator absolute bottom-0 left-0 right-0 h-1 rounded-t-full transition-all duration-300"></div>
      </button>
    </nav>
  </div>

  <!-- ÁèæÂú®ÂãüÈõÜ‰∏≠„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥ -->
  <div id="active-content" class="stages-list tab-content">
    <% if @active_recruitments.any? %>
      <% @active_recruitments.each do |recruitment| %>
        <div class="stage-card">
          <h2><%= link_to recruitment.title, multiplay_recruitment_path(recruitment) %></h2>
          <div class="stage-info">
            <span class="<%= status_badge_class(recruitment.status) %>"><%= status_text(recruitment.status) %></span>
            <% if recruitment.stage_guid.present? %>
              <% stage = recruitment.stage %>
              <% if stage %>
                <span class="stage-guid">
                  <%= link_to stage.title, stage_path(stage), class: "stage-link-white" %> - <%= t('app.common.guid') %>: <%= clipboard_copy(recruitment.stage_guid) %>
                </span>
              <% else %>
                <span class="stage-guid"><%= t('app.common.guid') %>: <%= clipboard_copy(recruitment.stage_guid) %></span>
              <% end %>
            <% end %>
            <% if recruitment.difficulty.present? %>
              <span class="difficulty"><%= t('app.common.difficulty_label') %>: <%= recruitment.difficulty %></span>
            <% end %>
            <span class="max-players"><%= t('app.common.max_players') %>: <%= recruitment.max_players %><%= t('app.common.people') %></span>
            <% if recruitment.end_time.present? %>
              <span class="end-time"><%= t('app.common.end_time') %>: <%= l(recruitment.end_time, format: :short) %></span>
            <% end %>
          </div>
          <p class="description"><%= truncate(recruitment.description, length: 200) %></p>
          <div class="meta">
            <span class="author">
              <%= t('app.common.posted_by') %>: <%= link_to recruitment.user.display_name, user_path(recruitment.user), class: "text-blue-600 hover:text-blue-800 underline" %>
              <% if recruitment.user.admin? %>
                <span class="admin-badge"><%= t('app.common.admin_badge') %></span>
              <% end %>
            </span>
            <span class="date"><%= t('app.common.posted_at') %>: <%= l(recruitment.created_at, format: :short) %></span>
            <span class="comments-count">üí¨ <%= t('app.common.comments_count', count: (recruitment.respond_to?(:comments_count) ? recruitment.comments_count : recruitment.comments.count)) %></span>
            <%= diff_time(recruitment.created_at, "span", { class: "diff-time" }, auto_update: true) %>
          </div>
        </div>
      <% end %>
    <% else %>
      <p class="no-stages"><%= t('app.multiplay.no_active_posts') %></p>
    <% end %>
  </div>

  <!-- ÈÅéÂéª„ÅÆÂãüÈõÜ„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥ -->
  <div id="past-content" class="stages-list tab-content hidden">
    <% if @past_recruitments.any? %>
      <% @past_recruitments.each do |recruitment| %>
        <div class="stage-card">
          <h2><%= link_to recruitment.title, multiplay_recruitment_path(recruitment) %></h2>
          <div class="stage-info">
            <span class="<%= status_badge_class(recruitment.status) %>"><%= status_text(recruitment.status) %></span>
            <% if recruitment.stage_guid.present? %>
              <% stage = recruitment.stage %>
              <% if stage %>
                <span class="stage-guid">
                  <%= link_to stage.title, stage_path(stage), class: "stage-link-white" %> - <%= t('app.common.guid') %>: <%= clipboard_copy(recruitment.stage_guid) %>
                </span>
              <% else %>
                <span class="stage-guid"><%= t('app.common.guid') %>: <%= clipboard_copy(recruitment.stage_guid) %></span>
              <% end %>
            <% end %>
            <% if recruitment.difficulty.present? %>
              <span class="difficulty"><%= t('app.common.difficulty_label') %>: <%= recruitment.difficulty %></span>
            <% end %>
            <span class="max-players"><%= t('app.common.max_players') %>: <%= recruitment.max_players %><%= t('app.common.people') %></span>
            <% if recruitment.end_time.present? %>
              <span class="end-time"><%= t('app.common.end_time') %>: <%= l(recruitment.end_time, format: :short) %></span>
            <% end %>
          </div>
          <p class="description"><%= truncate(recruitment.description, length: 200) %></p>
          <div class="meta">
            <span class="author">
              <%= t('app.common.posted_by') %>: <%= link_to recruitment.user.display_name, user_path(recruitment.user), class: "text-blue-600 hover:text-blue-800 underline" %>
              <% if recruitment.user.admin? %>
                <span class="admin-badge"><%= t('app.common.admin_badge') %></span>
              <% end %>
            </span>
            <span class="date"><%= t('app.common.posted_at') %>: <%= l(recruitment.created_at, format: :short) %></span>
            <span class="comments-count">üí¨ <%= t('app.common.comments_count', count: (recruitment.respond_to?(:comments_count) ? recruitment.comments_count : recruitment.comments.count)) %></span>
            <%= diff_time(recruitment.created_at, "span", { class: "diff-time" }, auto_update: true) %>
          </div>
        </div>
      <% end %>
    <% else %>
      <p class="no-stages"><%= t('app.multiplay.no_past_posts') %></p>
    <% end %>
  </div>
</div>

<style>
/* Ê§úÁ¥¢„Éà„Ç∞„É´„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´ */
.search-toggle-button {
  cursor: pointer;
  border: 2px solid transparent;
  width: 100%;
  display: flex;
}

.search-toggle-button:hover {
  background-color: #dbeafe !important;
  border: 2px solid #3b82f6;
}

.search-toggle-button:active {
  background-color: #bfdbfe !important;
}

.search-toggle-button:hover .search-icon {
  transform: scale(1.1);
  color: #2563eb;
}

.search-toggle-button:hover .search-text {
  color: #1e40af;
}

.search-toggle-button:hover .search-chevron {
  color: #2563eb;
  transform: scale(1.05);
}

.search-icon,
.search-text,
.search-chevron {
  transition: all 0.2s ease;
}

.search-icon {
  width: 16px;
  height: 16px;
  margin-left: 8px;
}

.search-chevron {
  width: 16px;
  height: 16px;
  margin-right: 8px;
}

/* „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
.tab-content {
  display: block;
  animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.tab-content.hidden {
  display: none !important;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* „Çø„Éñ„Éú„Çø„É≥„ÅÆ„Éá„Éï„Ç©„É´„Éà„Çπ„Çø„Ç§„É´ */
.tab-button {
  position: relative;
  background: transparent;
  color: #6b7280;
  backdrop-filter: blur(8px);
}

.tab-button:hover {
  background: rgba(255, 255, 255, 0.5);
  color: #374151;
}

/* „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çø„Éñ */
.tab-button.active {
  background: white;
  color: #047857;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
              0 2px 4px -1px rgba(0, 0, 0, 0.06),
              inset 0 -2px 0 0 #10b981;
}

.tab-button.active.past-active {
  color: #1f2937;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
              0 2px 4px -1px rgba(0, 0, 0, 0.06),
              inset 0 -2px 0 0 #6b7280;
}

/* „Éê„ÉÉ„Ç∏„ÅÆ„Çπ„Çø„Ç§„É´ */
.tab-button .tab-badge {
  background: #e5e7eb;
  color: #6b7280;
}

.tab-button.active .tab-badge {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
}

.tab-button.active.past-active .tab-badge {
  background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
  color: white;
  box-shadow: 0 2px 4px rgba(107, 114, 128, 0.3);
}

/* „Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº„É©„Ç§„É≥ */
.tab-indicator {
  background: transparent;
}

.tab-button.active .tab-indicator {
  background: linear-gradient(90deg, transparent, #10b981, transparent);
  box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
}

.tab-button.active.past-active .tab-indicator {
  background: linear-gradient(90deg, transparent, #6b7280, transparent);
  box-shadow: 0 0 8px rgba(107, 114, 128, 0.5);
}

/* SVG„Ç¢„Ç§„Ç≥„É≥„ÅÆ„Ç´„É©„Éº */
.tab-button svg {
  color: inherit;
  opacity: 0.7;
}

.tab-button.active svg {
  opacity: 1;
}
</style>

<script>
function switchTab(tabName) {
  // „Åô„Åπ„Å¶„ÅÆ„Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÈùûË°®Á§∫
  const allContents = document.querySelectorAll('.tab-content');
  allContents.forEach(content => {
    content.classList.add('hidden');
    content.style.display = 'none';
  });

  // „Åô„Åπ„Å¶„ÅÆ„Çø„Éñ„Éú„Çø„É≥„ÇíÈùû„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñ
  const allButtons = document.querySelectorAll('.tab-button');
  allButtons.forEach(button => {
    button.classList.remove('active', 'past-active');
  });

  // ÈÅ∏Êäû„Åï„Çå„Åü„Çø„Éñ„Çí„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÂåñ
  if (tabName === 'active') {
    const activeContent = document.getElementById('active-content');
    const activeTab = document.getElementById('active-tab');

    activeContent.classList.remove('hidden');
    activeContent.style.display = 'block';
    activeTab.classList.add('active');
  } else if (tabName === 'past') {
    const pastContent = document.getElementById('past-content');
    const pastTab = document.getElementById('past-tab');

    pastContent.classList.remove('hidden');
    pastContent.style.display = 'block';
    pastTab.classList.add('active', 'past-active');
  }
}

// ÂàùÊúüÂåñÔºö„Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çø„Éñ„ÇíË®≠ÂÆö
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('active-tab').classList.add('active');
});
</script>

