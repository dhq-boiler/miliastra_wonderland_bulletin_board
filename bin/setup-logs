#!/bin/bash
# Setup log directory on production server host
# Run this script before the first deployment to prepare host directory for log volume mounting

set -e

# Check if SERVER_IP_ADDRESS is set
if [ -z "$SERVER_IP_ADDRESS" ]; then
  # Try to load from .env file
  if [ -f .env ]; then
    export $(cat .env | grep -v '^#' | xargs)
  else
    echo "Error: SERVER_IP_ADDRESS not set and .env file not found"
    echo "Please set SERVER_IP_ADDRESS environment variable or create .env file"
    exit 1
  fi
fi

echo "Setting up log directory on host server: $SERVER_IP_ADDRESS"
echo "=========================================="

# Create log directory on host (EC2 server)
# This directory will be mounted to the Docker container
ssh ec2-user@$SERVER_IP_ADDRESS << 'ENDSSH'
  echo "Creating host log directory for volume mounting..."
  sudo mkdir -p /var/log/miliastra_wonderland_bulletin_board

  echo "Setting permissions..."
  # Set ownership to user 1000 (rails user in container)
  sudo chown 1000:1000 /var/log/miliastra_wonderland_bulletin_board
  sudo chmod 755 /var/log/miliastra_wonderland_bulletin_board

  echo "Verifying setup..."
  ls -la /var/log/miliastra_wonderland_bulletin_board

  echo ""
  echo "Host log directory setup complete!"
  echo "After deployment, logs will be accessible at: /var/log/miliastra_wonderland_bulletin_board/production.log"
ENDSSH

echo ""
echo "=========================================="
echo "Host setup completed successfully!"
echo ""
echo "Next steps:"
echo "  1. Deploy your application: bin/kamal deploy"
echo "  2. The docker-entrypoint will automatically setup the log directory in the container"
echo "  3. Logs will be written to both locations (host and container)"
echo ""
echo "To view logs, run one of the following commands:"
echo ""
echo "  # From local machine using Kamal:"
echo "  bin/kamal logs"
echo ""
echo "  # From server:"
echo "  ssh ec2-user@$SERVER_IP_ADDRESS 'tail -f /var/log/miliastra_wonderland_bulletin_board/production.log'"
echo ""
echo "See docs/LOG_ACCESS.md for more options."

