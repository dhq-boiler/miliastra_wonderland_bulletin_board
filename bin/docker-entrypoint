#!/bin/bash -e

# Setup log directory with proper permissions
# This handles both fresh installs and volume-mounted directories
echo "Setting up log directory permissions..."
mkdir -p /rails/log
touch /rails/log/production.log /rails/log/cron.log /rails/log/cron_error.log
chown -R rails:rails /rails/log
chmod -R 775 /rails/log
chmod 664 /rails/log/production.log /rails/log/cron.log /rails/log/cron_error.log
echo "Log directory setup complete!"

# Start cron daemon for scheduled tasks
echo "Starting cron daemon..."
service cron start
echo "Cron daemon started!"

# Optional: Run database migrations if AUTO_MIGRATE is set
# Check for both thrust and direct rails server commands
if [ "${AUTO_MIGRATE}" = "true" ]; then
  if [ "${1}" = "./bin/thrust" ] || [ "${1}" = "./bin/rails" ]; then
    echo "Running database migrations (AUTO_MIGRATE=true)..."
    gosu rails ./bin/rails db:create 2>&1 || true
    gosu rails ./bin/rails db:migrate 2>&1 || true
    echo "Database migrations complete!"
  fi
fi

# Execute the main command as rails user
exec gosu rails "${@}"
