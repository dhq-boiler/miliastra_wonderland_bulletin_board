#!/bin/bash -e

# If running the rails server then create or migrate existing database
# Set SKIP_DB_PREPARE=1 to skip database preparation (useful for debugging)
if [ "${@: -2:1}" == "./bin/rails" ] && [ "${@: -1:1}" == "server" ]; then
  if [ "${SKIP_DB_PREPARE}" != "1" ]; then
    echo "Preparing database..."

    # Try db:prepare first
    if ! ./bin/rails db:prepare 2>&1; then
      echo "db:prepare failed, trying db:schema:load..."
      # If db:prepare fails, try loading from schema files
      ./bin/rails db:schema:load || true
      ./bin/rails db:schema:load:cache || true
      ./bin/rails db:schema:load:queue || true
      ./bin/rails db:schema:load:cable || true
    fi
  else
    echo "Skipping database preparation (SKIP_DB_PREPARE=1)"
  fi
fi

exec "${@}"
